<head>
	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700" rel="stylesheet">
	<link href='style.css' rel='stylesheet' type='text/css'>
	<title>TransmedValues Quiz</title>
	<link rel="icon" type="x-icon" href="icon.png">
	<link rel="shortcut icon" type="x-icon" href="icon.png">
	<meta charset="utf-8">
</head>
<body>
	<h1>TransmedValues</h1>
	<hr>
	<h2 style="text-align:center;" id="question-number">Loading...</h2>
	<p class="question" id="question-text"></p>
	<button class="button stronglyAgree" onclick="next_question(1.0)">Strongly Agree</button> <br>
	<button class="button agree" onclick="next_question( 0.5)">Agree</button> <br>
	<button class="button somewhatAgree" onclick="next_question(0.25)">Somewhat Agree</button> <br>
	<button class="button neutral" onclick="next_question( 0.0)">Neutral/Unsure</button> <br>
	<button class="button somewhatDisagree" onclick="next_question(-0.25)">Somewhat Disagree</button> <br>
	<button class="button disagree" onclick="next_question(-0.5)">Disagree</button> <br>
	<button class="button stronglyDisagree" onclick="next_question(-1.0)">Strongly Disagree</button> <br>
	<button class="small_button" onclick="prev_question()" id="back_button">Back</button>
	<button class="small_button_off" id="back_button_off">Back</button><br>

	<!-- JavaScript for the test itself -->
	<script type="module">
		import { Qs, questions } from "./questions.js";
		import { a, ideologies } from "./ideologies.js";
		var max_gender, max_dysphoria, max_classification, max_outlook, max_tol, max_alliance; // Max possible scores
		max_gender = max_dysphoria = max_classification = max_outlook = max_tol = max_alliance = 0;
		let gender_array = new Array(questions.length);
		let dysphoria_array = new Array(questions.length);
		let classification_array = new Array(questions.length);
		let outlook_array = new Array(questions.length);
		let tol_array = new Array(questions.length);
		let alliance_array = new Array(questions.length);
		var qn = 0; // Question number

		var specialAnswers = new Map();
		init_question();
		for (var i = 0; i < questions.length; i++) {
			max_gender += Math.abs(sznn(i, "binary"))
			max_dysphoria += Math.abs(sznn(i, "strict"))
			max_classification += Math.abs(sznn(i, "protection"))
			max_outlook += Math.abs(sznn(i, "pride"))
			max_tol += Math.abs(sznn(i, "tolerance"))
			max_alliance += Math.abs(sznn(i, "unity"))
		}
		function init_question() {
			document.getElementById("question-text").innerHTML = questions[qn].question;
			document.getElementById("question-number").innerHTML = "Question " + (qn + 1) + " of " + (questions.length);
			if (qn == 0) {
				document.getElementById("back_button").style.display = 'none';
				document.getElementById("back_button_off").style.display = 'block';
			} else {
				document.getElementById("back_button").style.display = 'block';
				document.getElementById("back_button_off").style.display = 'none';
			}

		}

		function szn(something) {
			if (something in questions[qn].effect) {
				return questions[qn].effect[something];
			} else {
				return 0;
			}
		}
		function sznn(num, something) {
			if (something in questions[num].effect) {
				return questions[num].effect[something];
			} else {
				return 0;
			}
		}

		function next_question(mult) {
			let array = new Array(6);
			var gender = szn("binary");
			var dysphoria = szn("strict");
			var classification = szn("protection");
			var outlook = szn("pride");
			var tol = szn("tolerance");
			var alliance = szn("unity");
			/*var gender = szn(questions[qn].effect.binary);
			var dysphoria = szn(questions[qn].effect.strict);
			var classification = szn(questions[qn].effect.protection);
			var outlook = szn(questions[qn].effect.pride);
			var tol = szn(questions[qn].effect.tolerance);
			var alliance = szn(questions[qn].effect.unity);*/
			gender_array[qn] = mult * gender;
			dysphoria_array[qn] = mult * dysphoria;
			classification_array[qn] = mult * classification;
			outlook_array[qn] = mult * outlook;
			tol_array[qn] = mult * tol;
			alliance_array[qn] = mult * alliance;
			if ("id" in questions[qn]) specialAnswers.set(questions[qn].id, mult);
			qn++;
			if (qn < questions.length) {
				init_question();
			} else {
				results();
			}
		}
		window.next_question = next_question;

		function prev_question() {
			if (qn == 0) {
				return;
			}
			qn--;
			init_question();
		}
		window.prev_question = prev_question;

		function calc_score(score, max) {
			return (100 * (max + score) / (2 * max)).toFixed(1)
		}

		function results() {
			/*for (const [key, value] of specialAnswers.entries()) {
				console.log(key + ", " + value);
			}*/
			let final_gender = gender_array.reduce((a, b) => a + b, 0)
			let final_dysphoria = dysphoria_array.reduce((a, b) => a + b, 0)
			let final_classification = classification_array.reduce((a, b) => a + b, 0)
			let final_outlook = outlook_array.reduce((a, b) => a + b, 0)
			let final_tol = tol_array.reduce((a, b) => a + b, 0)
			let final_alliance = alliance_array.reduce((a, b) => a + b, 0)

			var ideodist = Infinity
			var dist;
			var ideologyName = "";
			for (var i = 0; i < ideologies.length; i++) {
				dist = 0
                var ideology = ideologies[i].stats;
                for (const [key, value] of specialAnswers.entries()) {
                    if (key in ideology) dist += Math.pow(Math.abs(value - ideology[key]), 2)
                }
				if (dist < ideodist) {
					ideologyName = ideologies[i].name
					ideodist = dist
				}
			}

			var gender_score = calc_score(final_gender, max_gender);
			var dysphoria_score = calc_score(final_dysphoria, max_dysphoria);
			var classification_score = calc_score(final_classification, max_classification);
			var outlook_score = calc_score(final_outlook, max_outlook);
			var tol_score = calc_score(final_tol, max_tol);
			var alliance_score = calc_score(final_alliance, max_alliance);

			location.href = `results.html`
				+ `?binary=${gender_score}`
				+ `&strict=${dysphoria_score}`
				+ `&protection=${classification_score}`
				+ `&pride=${outlook_score}`
				+ `&tolerance=${tol_score}`
				+ `&unity=${alliance_score}`
				+ `&ideology=${ideologyName}`
		}
	</script>
</body>